#!/usr/bin/env bash

set -e

REPO_ROOT=$(git rev-parse --show-toplevel)
BOILERPLATE_GIT_REPO="${BOILERPLATE_GIT_REPO:-https://github.com/openshift/boilerplate.git}"
BOILERPLATE_GIT_CLONE="${BOILERPLATE_GIT_CLONE:-/tmp/boilerplate}"

usage() {
    cat <<EOF
Usage: $0

Updates the boilerplate in this repository based on the conventions
configured in boilerplate/update.cfg.

Environment variables:
    BOILERPLATE_GIT_REPO: URL of the boilerplate repository to use.
                          Default: ${BOILERPLATE_GIT_REPO}
    BOILERPLATE_GIT_CLONE: Where to clone the boilerplate repository.
                           Default: ${BOILERPLATE_GIT_CLONE}

EOF
}

if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    usage
    exit 0
fi

# Clone or update the boilerplate repository
if [[ ! -d "${BOILERPLATE_GIT_CLONE}" ]]; then
    echo "Cloning boilerplate repository from ${BOILERPLATE_GIT_REPO}..."
    git clone "${BOILERPLATE_GIT_REPO}" "${BOILERPLATE_GIT_CLONE}"
else
    echo "Updating boilerplate repository..."
    (cd "${BOILERPLATE_GIT_CLONE}" && git pull)
fi

# Update the boilerplate/update script itself
echo "Updating boilerplate/update script..."
cp "${BOILERPLATE_GIT_CLONE}/boilerplate/update" "${REPO_ROOT}/boilerplate/update"
chmod +x "${REPO_ROOT}/boilerplate/update"

# Copy common library files
echo "Copying library files..."
mkdir -p "${REPO_ROOT}/boilerplate/_lib"
cp -r "${BOILERPLATE_GIT_CLONE}/boilerplate/_lib/"* "${REPO_ROOT}/boilerplate/_lib/" 2>/dev/null || true

# Process each convention in update.cfg
if [[ ! -f "${REPO_ROOT}/boilerplate/update.cfg" ]]; then
    echo "ERROR: boilerplate/update.cfg not found!"
    exit 1
fi

echo "Processing conventions from boilerplate/update.cfg..."
while IFS= read -r convention || [[ -n "$convention" ]]; do
    # Skip comments and empty lines
    [[ "$convention" =~ ^#.*$ ]] && continue
    [[ -z "$convention" ]] && continue
    
    convention_dir="${BOILERPLATE_GIT_CLONE}/boilerplate/${convention}"
    
    if [[ ! -d "$convention_dir" ]]; then
        echo "WARNING: Convention directory not found: $convention_dir"
        continue
    fi
    
    echo "Applying convention: $convention"
    
    # Copy convention files
    target_dir="${REPO_ROOT}/boilerplate/${convention}"
    mkdir -p "$target_dir"
    
    # Copy all files from the convention directory
    if [[ -d "$convention_dir" ]]; then
        cp -r "$convention_dir/"* "$target_dir/" 2>/dev/null || true
    fi
    
done < "${REPO_ROOT}/boilerplate/update.cfg"

# Generate the includes file
echo "Generating boilerplate/generated-includes.mk..."
{
    echo "# This file is generated by boilerplate/update. Do not edit directly."
    echo ""
    
    while IFS= read -r convention || [[ -n "$convention" ]]; do
        # Skip comments and empty lines
        [[ "$convention" =~ ^#.*$ ]] && continue
        [[ -z "$convention" ]] && continue
        
        # Check for standard.mk in this convention
        if [[ -f "${REPO_ROOT}/boilerplate/${convention}/standard.mk" ]]; then
            echo "include boilerplate/${convention}/standard.mk"
        fi
    done < "${REPO_ROOT}/boilerplate/update.cfg"
} > "${REPO_ROOT}/boilerplate/generated-includes.mk"

echo "Boilerplate update complete!"
